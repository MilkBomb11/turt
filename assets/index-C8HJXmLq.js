var Dt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var ts=Dt((I,C)=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();var pt=typeof global=="object"&&global&&global.Object===Object&&global,jt=typeof self=="object"&&self&&self.Object===Object&&self,L=pt||jt||Function("return this")(),U=L.Symbol,gt=Object.prototype,Mt=gt.hasOwnProperty,Ft=gt.toString,X=U?U.toStringTag:void 0;function Ut(t){var e=Mt.call(t,X),n=t[X];try{t[X]=void 0;var r=!0}catch{}var a=Ft.call(t);return r&&(e?t[X]=n:delete t[X]),a}var Gt=Object.prototype,qt=Gt.toString;function Vt(t){return qt.call(t)}var Wt="[object Null]",xt="[object Undefined]",Ge=U?U.toStringTag:void 0;function se(t){return t==null?t===void 0?xt:Wt:Ge&&Ge in Object(t)?Ut(t):Vt(t)}function V(t){return t!=null&&typeof t=="object"}var re=Array.isArray;function be(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}var Ht="[object AsyncFunction]",zt="[object Function]",Kt="[object GeneratorFunction]",Yt="[object Proxy]";function mt(t){if(!be(t))return!1;var e=se(t);return e==zt||e==Kt||e==Ht||e==Yt}var ve=L["__core-js_shared__"],qe=(function(){var t=/[^.]+$/.exec(ve&&ve.keys&&ve.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""})();function Jt(t){return!!qe&&qe in t}var Xt=Function.prototype,Zt=Xt.toString;function x(t){if(t!=null){try{return Zt.call(t)}catch{}try{return t+""}catch{}}return""}var Qt=/[\\^$.*+?()[\]{}|]/g,en=/^\[object .+?Constructor\]$/,tn=Function.prototype,nn=Object.prototype,rn=tn.toString,an=nn.hasOwnProperty,sn=RegExp("^"+rn.call(an).replace(Qt,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function on(t){if(!be(t)||Jt(t))return!1;var e=mt(t)?sn:en;return e.test(x(t))}function cn(t,e){return t?.[e]}function H(t,e){var n=cn(t,e);return on(n)?n:void 0}var Be=H(L,"WeakMap"),Ve=Object.create,un=(function(){function t(){}return function(e){if(!be(e))return{};if(Ve)return Ve(e);t.prototype=e;var n=new t;return t.prototype=void 0,n}})(),We=(function(){try{var t=H(Object,"defineProperty");return t({},"",{}),t}catch{}})();function ln(t,e){for(var n=-1,r=t==null?0:t.length;++n<r&&e(t[n],n,t)!==!1;);return t}var dn=9007199254740991,fn=/^(?:0|[1-9]\d*)$/;function hn(t,e){var n=typeof t;return e=e??dn,!!e&&(n=="number"||n!="symbol"&&fn.test(t))&&t>-1&&t%1==0&&t<e}function pn(t,e,n){e=="__proto__"&&We?We(t,e,{configurable:!0,enumerable:!0,value:n,writable:!0}):t[e]=n}function je(t,e){return t===e||t!==t&&e!==e}var gn=Object.prototype,mn=gn.hasOwnProperty;function bn(t,e,n){var r=t[e];(!(mn.call(t,e)&&je(r,n))||n===void 0&&!(e in t))&&pn(t,e,n)}var kn=9007199254740991;function bt(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=kn}function yn(t){return t!=null&&bt(t.length)&&!mt(t)}var vn=Object.prototype;function kt(t){var e=t&&t.constructor,n=typeof e=="function"&&e.prototype||vn;return t===n}function On(t,e){for(var n=-1,r=Array(t);++n<t;)r[n]=e(n);return r}var $n="[object Arguments]";function xe(t){return V(t)&&se(t)==$n}var yt=Object.prototype,wn=yt.hasOwnProperty,Sn=yt.propertyIsEnumerable,Bn=xe((function(){return arguments})())?xe:function(t){return V(t)&&wn.call(t,"callee")&&!Sn.call(t,"callee")};function Pn(){return!1}var vt=typeof I=="object"&&I&&!I.nodeType&&I,He=vt&&typeof C=="object"&&C&&!C.nodeType&&C,En=He&&He.exports===vt,ze=En?L.Buffer:void 0,_n=ze?ze.isBuffer:void 0,de=_n||Pn,An="[object Arguments]",Rn="[object Array]",In="[object Boolean]",Cn="[object Date]",Nn="[object Error]",Tn="[object Function]",Ln="[object Map]",Dn="[object Number]",jn="[object Object]",Mn="[object RegExp]",Fn="[object Set]",Un="[object String]",Gn="[object WeakMap]",qn="[object ArrayBuffer]",Vn="[object DataView]",Wn="[object Float32Array]",xn="[object Float64Array]",Hn="[object Int8Array]",zn="[object Int16Array]",Kn="[object Int32Array]",Yn="[object Uint8Array]",Jn="[object Uint8ClampedArray]",Xn="[object Uint16Array]",Zn="[object Uint32Array]",$={};$[Wn]=$[xn]=$[Hn]=$[zn]=$[Kn]=$[Yn]=$[Jn]=$[Xn]=$[Zn]=!0;$[An]=$[Rn]=$[qn]=$[In]=$[Vn]=$[Cn]=$[Nn]=$[Tn]=$[Ln]=$[Dn]=$[jn]=$[Mn]=$[Fn]=$[Un]=$[Gn]=!1;function Qn(t){return V(t)&&bt(t.length)&&!!$[se(t)]}function Me(t){return function(e){return t(e)}}var Ot=typeof I=="object"&&I&&!I.nodeType&&I,ee=Ot&&typeof C=="object"&&C&&!C.nodeType&&C,er=ee&&ee.exports===Ot,Oe=er&&pt.process,J=(function(){try{var t=ee&&ee.require&&ee.require("util").types;return t||Oe&&Oe.binding&&Oe.binding("util")}catch{}})(),Ke=J&&J.isTypedArray,$t=Ke?Me(Ke):Qn,tr=Object.prototype,nr=tr.hasOwnProperty;function rr(t,e){var n=re(t),r=!n&&Bn(t),a=!n&&!r&&de(t),i=!n&&!r&&!a&&$t(t),o=n||r||a||i,d=o?On(t.length,String):[],c=d.length;for(var l in t)nr.call(t,l)&&!(o&&(l=="length"||a&&(l=="offset"||l=="parent")||i&&(l=="buffer"||l=="byteLength"||l=="byteOffset")||hn(l,c)))&&d.push(l);return d}function wt(t,e){return function(n){return t(e(n))}}var ar=wt(Object.keys,Object),ir=Object.prototype,sr=ir.hasOwnProperty;function or(t){if(!kt(t))return ar(t);var e=[];for(var n in Object(t))sr.call(t,n)&&n!="constructor"&&e.push(n);return e}function cr(t){return yn(t)?rr(t):or(t)}var ae=H(Object,"create");function ur(){this.__data__=ae?ae(null):{},this.size=0}function lr(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var dr="__lodash_hash_undefined__",fr=Object.prototype,hr=fr.hasOwnProperty;function pr(t){var e=this.__data__;if(ae){var n=e[t];return n===dr?void 0:n}return hr.call(e,t)?e[t]:void 0}var gr=Object.prototype,mr=gr.hasOwnProperty;function br(t){var e=this.__data__;return ae?e[t]!==void 0:mr.call(e,t)}var kr="__lodash_hash_undefined__";function yr(t,e){var n=this.__data__;return this.size+=this.has(t)?0:1,n[t]=ae&&e===void 0?kr:e,this}function W(t){var e=-1,n=t==null?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}W.prototype.clear=ur;W.prototype.delete=lr;W.prototype.get=pr;W.prototype.has=br;W.prototype.set=yr;function vr(){this.__data__=[],this.size=0}function ke(t,e){for(var n=t.length;n--;)if(je(t[n][0],e))return n;return-1}var Or=Array.prototype,$r=Or.splice;function wr(t){var e=this.__data__,n=ke(e,t);if(n<0)return!1;var r=e.length-1;return n==r?e.pop():$r.call(e,n,1),--this.size,!0}function Sr(t){var e=this.__data__,n=ke(e,t);return n<0?void 0:e[n][1]}function Br(t){return ke(this.__data__,t)>-1}function Pr(t,e){var n=this.__data__,r=ke(n,t);return r<0?(++this.size,n.push([t,e])):n[r][1]=e,this}function j(t){var e=-1,n=t==null?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}j.prototype.clear=vr;j.prototype.delete=wr;j.prototype.get=Sr;j.prototype.has=Br;j.prototype.set=Pr;var ie=H(L,"Map");function Er(){this.size=0,this.__data__={hash:new W,map:new(ie||j),string:new W}}function _r(t){var e=typeof t;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?t!=="__proto__":t===null}function ye(t,e){var n=t.__data__;return _r(e)?n[typeof e=="string"?"string":"hash"]:n.map}function Ar(t){var e=ye(this,t).delete(t);return this.size-=e?1:0,e}function Rr(t){return ye(this,t).get(t)}function Ir(t){return ye(this,t).has(t)}function Cr(t,e){var n=ye(this,t),r=n.size;return n.set(t,e),this.size+=n.size==r?0:1,this}function z(t){var e=-1,n=t==null?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}z.prototype.clear=Er;z.prototype.delete=Ar;z.prototype.get=Rr;z.prototype.has=Ir;z.prototype.set=Cr;function Nr(t,e){for(var n=-1,r=e.length,a=t.length;++n<r;)t[a+n]=e[n];return t}var Tr=wt(Object.getPrototypeOf,Object);function Lr(){this.__data__=new j,this.size=0}function Dr(t){var e=this.__data__,n=e.delete(t);return this.size=e.size,n}function jr(t){return this.__data__.get(t)}function Mr(t){return this.__data__.has(t)}var Fr=200;function Ur(t,e){var n=this.__data__;if(n instanceof j){var r=n.__data__;if(!ie||r.length<Fr-1)return r.push([t,e]),this.size=++n.size,this;n=this.__data__=new z(r)}return n.set(t,e),this.size=n.size,this}function D(t){var e=this.__data__=new j(t);this.size=e.size}D.prototype.clear=Lr;D.prototype.delete=Dr;D.prototype.get=jr;D.prototype.has=Mr;D.prototype.set=Ur;var St=typeof I=="object"&&I&&!I.nodeType&&I,Ye=St&&typeof C=="object"&&C&&!C.nodeType&&C,Gr=Ye&&Ye.exports===St,Je=Gr?L.Buffer:void 0;Je&&Je.allocUnsafe;function qr(t,e){return t.slice()}function Vr(t,e){for(var n=-1,r=t==null?0:t.length,a=0,i=[];++n<r;){var o=t[n];e(o,n,t)&&(i[a++]=o)}return i}function Wr(){return[]}var xr=Object.prototype,Hr=xr.propertyIsEnumerable,Xe=Object.getOwnPropertySymbols,zr=Xe?function(t){return t==null?[]:(t=Object(t),Vr(Xe(t),function(e){return Hr.call(t,e)}))}:Wr;function Kr(t,e,n){var r=e(t);return re(t)?r:Nr(r,n(t))}function Pe(t){return Kr(t,cr,zr)}var Ee=H(L,"DataView"),_e=H(L,"Promise"),Ae=H(L,"Set"),Ze="[object Map]",Yr="[object Object]",Qe="[object Promise]",et="[object Set]",tt="[object WeakMap]",nt="[object DataView]",Jr=x(Ee),Xr=x(ie),Zr=x(_e),Qr=x(Ae),ea=x(Be),T=se;(Ee&&T(new Ee(new ArrayBuffer(1)))!=nt||ie&&T(new ie)!=Ze||_e&&T(_e.resolve())!=Qe||Ae&&T(new Ae)!=et||Be&&T(new Be)!=tt)&&(T=function(t){var e=se(t),n=e==Yr?t.constructor:void 0,r=n?x(n):"";if(r)switch(r){case Jr:return nt;case Xr:return Ze;case Zr:return Qe;case Qr:return et;case ea:return tt}return e});var ta=Object.prototype,na=ta.hasOwnProperty;function ra(t){var e=t.length,n=new t.constructor(e);return e&&typeof t[0]=="string"&&na.call(t,"index")&&(n.index=t.index,n.input=t.input),n}var fe=L.Uint8Array;function Fe(t){var e=new t.constructor(t.byteLength);return new fe(e).set(new fe(t)),e}function aa(t,e){var n=Fe(t.buffer);return new t.constructor(n,t.byteOffset,t.byteLength)}var ia=/\w*$/;function sa(t){var e=new t.constructor(t.source,ia.exec(t));return e.lastIndex=t.lastIndex,e}var rt=U?U.prototype:void 0,at=rt?rt.valueOf:void 0;function oa(t){return at?Object(at.call(t)):{}}function ca(t,e){var n=Fe(t.buffer);return new t.constructor(n,t.byteOffset,t.length)}var ua="[object Boolean]",la="[object Date]",da="[object Map]",fa="[object Number]",ha="[object RegExp]",pa="[object Set]",ga="[object String]",ma="[object Symbol]",ba="[object ArrayBuffer]",ka="[object DataView]",ya="[object Float32Array]",va="[object Float64Array]",Oa="[object Int8Array]",$a="[object Int16Array]",wa="[object Int32Array]",Sa="[object Uint8Array]",Ba="[object Uint8ClampedArray]",Pa="[object Uint16Array]",Ea="[object Uint32Array]";function _a(t,e,n){var r=t.constructor;switch(e){case ba:return Fe(t);case ua:case la:return new r(+t);case ka:return aa(t);case ya:case va:case Oa:case $a:case wa:case Sa:case Ba:case Pa:case Ea:return ca(t);case da:return new r;case fa:case ga:return new r(t);case ha:return sa(t);case pa:return new r;case ma:return oa(t)}}function Aa(t){return typeof t.constructor=="function"&&!kt(t)?un(Tr(t)):{}}var Ra="[object Map]";function Ia(t){return V(t)&&T(t)==Ra}var it=J&&J.isMap,Ca=it?Me(it):Ia,Na="[object Set]";function Ta(t){return V(t)&&T(t)==Na}var st=J&&J.isSet,La=st?Me(st):Ta,Bt="[object Arguments]",Da="[object Array]",ja="[object Boolean]",Ma="[object Date]",Fa="[object Error]",Pt="[object Function]",Ua="[object GeneratorFunction]",Ga="[object Map]",qa="[object Number]",Et="[object Object]",Va="[object RegExp]",Wa="[object Set]",xa="[object String]",Ha="[object Symbol]",za="[object WeakMap]",Ka="[object ArrayBuffer]",Ya="[object DataView]",Ja="[object Float32Array]",Xa="[object Float64Array]",Za="[object Int8Array]",Qa="[object Int16Array]",ei="[object Int32Array]",ti="[object Uint8Array]",ni="[object Uint8ClampedArray]",ri="[object Uint16Array]",ai="[object Uint32Array]",O={};O[Bt]=O[Da]=O[Ka]=O[Ya]=O[ja]=O[Ma]=O[Ja]=O[Xa]=O[Za]=O[Qa]=O[ei]=O[Ga]=O[qa]=O[Et]=O[Va]=O[Wa]=O[xa]=O[Ha]=O[ti]=O[ni]=O[ri]=O[ai]=!0;O[Fa]=O[Pt]=O[za]=!1;function le(t,e,n,r,a,i){var o;if(o!==void 0)return o;if(!be(t))return t;var d=re(t);if(d)o=ra(t);else{var c=T(t),l=c==Pt||c==Ua;if(de(t))return qr(t);if(c==Et||c==Bt||l&&!a)o=l?{}:Aa(t);else{if(!O[c])return a?t:{};o=_a(t,c)}}i||(i=new D);var g=i.get(t);if(g)return g;i.set(t,o),La(t)?t.forEach(function(y){o.add(le(y,e,n,y,t,i))}):Ca(t)&&t.forEach(function(y,v){o.set(v,le(y,e,n,v,t,i))});var p=Pe,m=d?void 0:p(t);return ln(m||t,function(y,v){m&&(v=y,y=t[v]),bn(o,v,le(y,e,n,v,t,i))}),o}var ii=1,si=4;function S(t){return le(t,ii|si)}var oi="__lodash_hash_undefined__";function ci(t){return this.__data__.set(t,oi),this}function ui(t){return this.__data__.has(t)}function he(t){var e=-1,n=t==null?0:t.length;for(this.__data__=new z;++e<n;)this.add(t[e])}he.prototype.add=he.prototype.push=ci;he.prototype.has=ui;function li(t,e){for(var n=-1,r=t==null?0:t.length;++n<r;)if(e(t[n],n,t))return!0;return!1}function di(t,e){return t.has(e)}var fi=1,hi=2;function _t(t,e,n,r,a,i){var o=n&fi,d=t.length,c=e.length;if(d!=c&&!(o&&c>d))return!1;var l=i.get(t),g=i.get(e);if(l&&g)return l==e&&g==t;var p=-1,m=!0,y=n&hi?new he:void 0;for(i.set(t,e),i.set(e,t);++p<d;){var v=t[p],N=e[p];if(r)var M=o?r(N,v,p,e,t,i):r(v,N,p,t,e,i);if(M!==void 0){if(M)continue;m=!1;break}if(y){if(!li(e,function(G,q){if(!di(y,q)&&(v===G||a(v,G,n,r,i)))return y.push(q)})){m=!1;break}}else if(!(v===N||a(v,N,n,r,i))){m=!1;break}}return i.delete(t),i.delete(e),m}function pi(t){var e=-1,n=Array(t.size);return t.forEach(function(r,a){n[++e]=[a,r]}),n}function gi(t){var e=-1,n=Array(t.size);return t.forEach(function(r){n[++e]=r}),n}var mi=1,bi=2,ki="[object Boolean]",yi="[object Date]",vi="[object Error]",Oi="[object Map]",$i="[object Number]",wi="[object RegExp]",Si="[object Set]",Bi="[object String]",Pi="[object Symbol]",Ei="[object ArrayBuffer]",_i="[object DataView]",ot=U?U.prototype:void 0,$e=ot?ot.valueOf:void 0;function Ai(t,e,n,r,a,i,o){switch(n){case _i:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case Ei:return!(t.byteLength!=e.byteLength||!i(new fe(t),new fe(e)));case ki:case yi:case $i:return je(+t,+e);case vi:return t.name==e.name&&t.message==e.message;case wi:case Bi:return t==e+"";case Oi:var d=pi;case Si:var c=r&mi;if(d||(d=gi),t.size!=e.size&&!c)return!1;var l=o.get(t);if(l)return l==e;r|=bi,o.set(t,e);var g=_t(d(t),d(e),r,a,i,o);return o.delete(t),g;case Pi:if($e)return $e.call(t)==$e.call(e)}return!1}var Ri=1,Ii=Object.prototype,Ci=Ii.hasOwnProperty;function Ni(t,e,n,r,a,i){var o=n&Ri,d=Pe(t),c=d.length,l=Pe(e),g=l.length;if(c!=g&&!o)return!1;for(var p=c;p--;){var m=d[p];if(!(o?m in e:Ci.call(e,m)))return!1}var y=i.get(t),v=i.get(e);if(y&&v)return y==e&&v==t;var N=!0;i.set(t,e),i.set(e,t);for(var M=o;++p<c;){m=d[p];var G=t[m],q=e[m];if(r)var Ue=o?r(q,G,m,e,t,i):r(G,q,m,t,e,i);if(!(Ue===void 0?G===q||a(G,q,n,r,i):Ue)){N=!1;break}M||(M=m=="constructor")}if(N&&!M){var oe=t.constructor,ce=e.constructor;oe!=ce&&"constructor"in t&&"constructor"in e&&!(typeof oe=="function"&&oe instanceof oe&&typeof ce=="function"&&ce instanceof ce)&&(N=!1)}return i.delete(t),i.delete(e),N}var Ti=1,ct="[object Arguments]",ut="[object Array]",ue="[object Object]",Li=Object.prototype,lt=Li.hasOwnProperty;function Di(t,e,n,r,a,i){var o=re(t),d=re(e),c=o?ut:T(t),l=d?ut:T(e);c=c==ct?ue:c,l=l==ct?ue:l;var g=c==ue,p=l==ue,m=c==l;if(m&&de(t)){if(!de(e))return!1;o=!0,g=!1}if(m&&!g)return i||(i=new D),o||$t(t)?_t(t,e,n,r,a,i):Ai(t,e,c,n,r,a,i);if(!(n&Ti)){var y=g&&lt.call(t,"__wrapped__"),v=p&&lt.call(e,"__wrapped__");if(y||v){var N=y?t.value():t,M=v?e.value():e;return i||(i=new D),a(N,M,n,r,i)}}return m?(i||(i=new D),Ni(t,e,n,r,a,i)):!1}function At(t,e,n,r,a){return t===e?!0:t==null||e==null||!V(t)&&!V(e)?t!==t&&e!==e:Di(t,e,n,r,At,a)}function pe(t,e){return At(t,e)}function w(t){throw new Error(`Did not expect to get here with value: ${t}`)}function f(t,e){throw new Error(`line[${t}]: ${e}.`)}function A(t){return t?1:0}function dt(t,e){const n=S(t);for(const r of e)n.add(r);return n}function ji(t,e){const n=S(t);for(const r of e)n.delete(r);return n}let Rt=0,E=()=>`%r${Rt++}`,Mi=()=>{Rt=0},It=0,F=()=>`.L${It++}`,Fi=()=>{It=0};var h;(t=>{t.Int={kind:"Int"},t.Bool={kind:"Bool"},t.Ptr=i=>({kind:"Ptr",inner:i}),t.Func=(i,o)=>({kind:"Func",args:i,returnType:o}),t.atoms=new Set(["int","bool","ptr"]);function e(i,o){if(i===o)return!0;if(i.kind!==o.kind)return!1;switch(i.kind){case"Int":case"Bool":return!0;case"Ptr":{const d=o;return e(i.inner,d.inner)}case"Func":{const d=o;if(!e(i.returnType,d.returnType)||i.args.length!==d.args.length)return!1;for(let c=0;c<i.args.length;c++)if(!e(i.args[c],d.args[c]))return!1;return!0}default:w(i)}}t.isEqual=e;function n(i){switch(i.kind){case"Int":return k.Int;case"Bool":return k.Bool;case"Ptr":return k.Ptr(n(i.inner));case"Func":f(0,`Typecheck failure: cannot convert ${r(i)} to matching arth. This should've been forbidden`);default:w(i)}}t.toArth=n;function r(i){switch(i.kind){case"Int":return"Int";case"Bool":return"Bool";case"Ptr":return`Ptr(${r(i.inner)})`;case"Func":return`(${i.args.map(r).join(",")}) -> ${r(i.returnType)}`;default:w(i)}}t.stringOfType=r;function a(i){return`${i.name}:${r(i.type)}`}t.stringOfNameTypePair=a})(h||(h={}));var k;(t=>{t.Int={kind:"Int"},t.Bool={kind:"Bool"},t.Ptr=n=>({kind:"Ptr",inner:n});function e(n,r){if(n===r)return!0;if(n.kind!==r.kind)return!1;switch(n.kind){case"Int":case"Bool":return!0;case"Ptr":{const a=r;return e(n.inner,a.inner)}default:w(n)}}t.isEqual=e})(k||(k={}));const we=(t,e)=>({kind:"NameTypePair",name:t,type:e});var b;(t=>{t.If=(e,n,r,a)=>({kind:"If",lineNum:e,cond:n,true_arm:r,false_arm:a}),t.While=(e,n,r)=>({kind:"While",lineNum:e,cond:n,body:r}),t.FnDecl=(e,n,r,a,i)=>({kind:"FnDecl",lineNum:e,name:n,args:r,returnType:i,body:a}),t.Block=(e,n)=>({kind:"Block",lineNum:e,stmts:n}),t.VarDecl=(e,n,r)=>({kind:"VarDecl",lineNum:e,ntp:n,expr:r}),t.PtrUpdate=(e,n,r)=>({kind:"PtrUpdate",lineNum:e,left:n,right:r}),t.Return=(e,n)=>({kind:"Return",lineNum:e,expr:n}),t.ExprStmt=(e,n)=>({kind:"ExprStmt",lineNum:e,expr:n}),t.Break=e=>({kind:"Break",lineNum:e}),t.Continue=e=>({kind:"Continue",lineNum:e}),t.Const=(e,n)=>({kind:"Const",lineNum:e,value:n}),t.Var=(e,n)=>({kind:"Var",lineNum:e,name:n}),t.Assign=(e,n,r)=>({kind:"Assign",lineNum:e,name:n,expr:r}),t.BinOp=(e,n,r,a)=>({kind:"BinOp",lineNum:e,left:n,op:r,right:a}),t.UnOp=(e,n,r)=>({kind:"UnOp",lineNum:e,op:n,operand:r}),t.Cast=(e,n,r)=>({kind:"Cast",lineNum:e,left:n,type:r}),t.AddrOf=(e,n)=>({kind:"AddrOf",lineNum:e,operand:n}),t.Deref=(e,n)=>({kind:"Deref",lineNum:e,operand:n}),t.Call=(e,n,r,a)=>({kind:"Call",lineNum:e,calleeName:n,args:r,returnType:a})})(b||(b={}));(t=>{function e(a){switch(a.kind){case"Const":return`Const(${a.value.toString()})`;case"Var":return`Var(${a.name})`;case"BinOp":return`BinOp(${e(a.left)}, ${a.op}, ${e(a.right)})`;case"UnOp":return`UnOp(${a.op}, ${e(a.operand)})`;case"Deref":return`Deref(${e(a.operand)})`;case"PtrUpdate":return`PtrUpdate(${e(a.left)}, ${e(a.right)})`;case"AddrOf":return`AddrOf(${a.operand})`;case"Assign":return`Assign(${a.name}, ${e(a.expr)})`;case"Cast":return`Cast(${e(a.left)}, ${h.stringOfType(a.type)})`;case"Call":{let i=a.args.map(e);return a.returnType===void 0?`Call(${a.calleeName}, ${i.join(`
`)}, undefined)`:`Call(${a.calleeName}, ${i.join(`
`)}, ${h.stringOfType(a.returnType)})`}default:w(a)}}t.stringOfExpr=e;function n(a){switch(a.kind){case"Break":return"Break";case"Continue":return"Continue";case"Return":return`Return(${e(a.expr)})`;case"ExprStmt":return`ExprStmt(${e(a.expr)})`;case"FnDecl":{let i=a.args.map(h.stringOfNameTypePair).join(",");return`FnDecl(${a.name}, [${i}] -> ${h.stringOfType(a.returnType)}, ${n(a.body)})`}case"If":return`If(${e(a.cond)}, ${n(a.true_arm)}, ${n(a.false_arm)})`;case"While":return`While(${e(a.cond)}, ${n(a.body)})`;case"VarDecl":{let i=e(a.expr);return`Let(${h.stringOfNameTypePair(a.ntp)}, ${i})`}case"Block":return`Block(${r(a.stmts)})`;default:w(a)}}function r(a){return a.map(n).join(`
`)}t.stringOfStmts=r})(b||(b={}));class Ct{constructor(e){this.code=e,this.predMap=new Map,this.predMap.set(0,new Set),this.succMap=new Map,this.labelMap=new Map;for(let n=0;n<this.code.length;n++){const r=this.code[n];r.kind==="Label"&&this.labelMap.set(r.label,n)}this.makeMaps()}predMap;succMap;labelMap;getPreds(e){return this.predMap.get(e)}getSuccs(e){return this.succMap.get(e)}getInstr(e){return this.code[e]}makeMaps(){for(let e=0;e<this.code.length;e++){const n=this.code[e];switch(n.kind){case"GotoT":case"GotoF":{typeof n.dest=="number"&&f(e,"label was unexpectedly resolved");const r=this.labelMap.get(n.dest);let a=this.predMap.get(r);if(a===void 0&&(a=new Set,this.predMap.set(r,a)),a.add(e),e+1<this.code.length){this.succMap.set(e,new Set([e+1,r]));let i=this.predMap.get(e+1);i===void 0&&(i=new Set,this.predMap.set(e+1,i)),i.add(e)}else this.succMap.set(e,new Set([r]));break}case"Goto":{typeof n.dest=="number"&&f(e,"label was unexpectedly resolved");const r=this.labelMap.get(n.dest);this.succMap.set(e,new Set([r]));const a=this.predMap.get(r);a===void 0?this.predMap.set(r,new Set([e])):a.add(e);break}case"Alloc":case"BinOp":case"Call":case"FnDecl":case"Label":case"LoadByte":case"LoadWord":case"StoreByte":case"StoreWord":case"Print":case"Set":case"UnOp":{if(e+1<this.code.length){this.succMap.set(e,new Set([e+1]));let r=this.predMap.get(e+1);r===void 0&&(r=new Set,this.predMap.set(e+1,r)),r.add(e)}else this.succMap.set(e,new Set);break}case"Ret":case"Halt":this.succMap.set(e,new Set);break;default:w(n)}}}stringOfSet(e){const n=[];for(const r of e)n.push(r);return`[${n.join(",")}]`}stringOfMap(e){let n="";for(const[r,a]of e)n+=`${r} -> ${this.stringOfSet(a)}
`;return n}toString(){const e=this.stringOfMap(this.predMap),n=this.stringOfMap(this.succMap);return`<predecessor map>
${e}<successor map>
${n}`}}var s;(t=>{t.Reg=e=>({kind:"Reg",name:e}),t.Imm=e=>({kind:"Imm",value:e}),t.Alloc=(e,n)=>({kind:"Alloc",dest:e,operand:n}),t.Print=(e,n)=>({kind:"Print",dest:e,operand:n}),t.Set=(e,n)=>({kind:"Set",left:e,right:n}),t.BinOp=(e,n,r,a)=>({kind:"BinOp",left:e,op:n,right1:r,right2:a}),t.UnOp=(e,n,r)=>({kind:"UnOp",left:e,op:n,right:r}),t.LoadWord=(e,n)=>({kind:"LoadWord",dest:e,src:n}),t.LoadByte=(e,n)=>({kind:"LoadByte",dest:e,src:n}),t.StoreWord=(e,n)=>({kind:"StoreWord",src:e,dest:n}),t.StoreByte=(e,n)=>({kind:"StoreByte",src:e,dest:n}),t.Label=e=>({kind:"Label",label:e}),t.Goto=e=>({kind:"Goto",dest:e}),t.GotoT=(e,n)=>({kind:"GotoT",cond:e,dest:n}),t.GotoF=(e,n)=>({kind:"GotoF",cond:e,dest:n}),t.Call=(e,n,r)=>({kind:"Call",dest:e,calleeName:n,args:r}),t.Ret=e=>({kind:"Ret",operand:e}),t.FnDecl=(e,n,r)=>({kind:"FnDecl",name:e,args:n,body:r}),t.Halt={kind:"Halt"}})(s||(s={}));(t=>{(e=>{e.Add="+",e.Sub="-",e.Mul="*",e.Div="/",e.Lt="<",e.Leq="<=",e.Gt=">",e.Geq=">=",e.Eq="==",e.Neq="!="})(t.BinOperator||(t.BinOperator={})),(e=>{e.Neg="-",e.UPlus="+",e.Not="!"})(t.UnOperator||(t.UnOperator={}))})(s||(s={}));(t=>{function e(a){switch(a.kind){case"Imm":return`${a.value}`;case"Reg":return a.name;default:w(a)}}function n(a,i){switch(a.kind){case"Alloc":return`${a.dest} = alloc(${e(a.operand)})`;case"BinOp":return`${a.left} = ${e(a.right1)} ${a.op} ${e(a.right2)}`;case"UnOp":return`${a.left} = ${a.op} ${e(a.right)}`;case"Call":return`${a.dest} = call (${a.calleeName}|${a.args.map(e).join(",")})`;case"FnDecl":return`fn ${a.name} [${a.args.join(",")}]:
${r(a.body,i+"    ")}`;case"Goto":return`goto ${a.dest}`;case"GotoF":return`if not ${e(a.cond)} goto ${a.dest}`;case"GotoT":return`if ${e(a.cond)} goto ${a.dest}`;case"Label":return`label ${a.label}`;case"LoadByte":return`${a.dest} = *(${a.src}) [byte]`;case"LoadWord":return`${a.dest} = *(${a.src}) [word]`;case"StoreByte":return`*(${a.dest}) = ${e(a.src)} [byte]`;case"StoreWord":return`*(${a.dest}) = ${e(a.src)} [word]`;case"Ret":return`ret ${e(a.operand)}`;case"Set":return`${a.left} = ${e(a.right)}`;case"Print":return`${a.dest} = print ${e(a.operand)}`;case"Halt":return"halt";default:w(a)}}function r(a,i=""){return a.map(o=>n(o,i)).map((o,d)=>`${i}${d}: ${o}`).join(`
`)+`
`}t.stringOfInstrs=r})(s||(s={}));const B=t=>({kind:"Constant",inner:t}),K={kind:"Nac"},Y={kind:"Undef"};class Ui{constructor(e){this.instrs=e,this.cfg=new Ct(e),this.allVars=this.getAllVars(),this.allParams=new Set;for(const n of this.allVars)n[0]!=="%"&&this.allParams.add(n);this.inSets=[],this.outSets=[]}cfg;allVars;allParams;inSets;outSets;joinC(e,n){return e.kind==="Nac"||n.kind==="Nac"?K:e.kind==="Undef"?S(n):n.kind==="Undef"||e.inner===n.inner?S(e):K}joinD(e,n){const r=new Map;for(const[a,i]of e){const o=S(n.get(a));o===void 0&&f(0,`cannot find variable ${a} to join.`),r.set(a,this.joinC(i,o))}return r}getAllVars(){const e=new Set;for(const n of this.instrs){const r=this.getVarsOfInstr(n);for(const a of r)e.add(a)}return e}initialD(){const e=new Map;for(const n of this.allVars)e.set(n,Y);for(const n of this.allParams)e.set(n,K);return e}getVarsOfInstr(e){switch(e.kind){case"Alloc":{const n=new Set([e.dest]);return e.operand.kind==="Reg"&&n.add(e.operand.name),n}case"Set":{const n=new Set([e.left]);return e.right.kind==="Reg"&&n.add(e.right.name),n}case"BinOp":{const n=new Set([e.left]);return e.right1.kind==="Reg"&&n.add(e.right1.name),e.right2.kind==="Reg"&&n.add(e.right2.name),n}case"UnOp":{const n=new Set([e.left]);return e.right.kind==="Reg"&&n.add(e.right.name),n}case"Call":{const n=new Set([e.dest]);for(const r of e.args)r.kind==="Reg"&&n.add(r.name);return n}case"GotoT":case"GotoF":return e.cond.kind==="Reg"?new Set([e.cond.name]):new Set;case"Print":case"Ret":return e.operand.kind==="Reg"?new Set([e.operand.name]):new Set;case"StoreByte":case"StoreWord":{const n=new Set([e.dest]);return e.src.kind==="Reg"&&n.add(e.src.name),n}case"LoadByte":case"LoadWord":return new Set([e.dest,e.src]);case"FnDecl":case"Goto":case"Halt":case"Label":return new Set;default:w(e)}}bopC(e,n,r){if(e.kind==="Nac"||r.kind==="Nac")return K;if(e.kind==="Undef"||r.kind==="Undef")return Y;if(e.kind==="Constant"&&r.kind==="Constant")switch(n){case s.BinOperator.Add:return B(e.inner+r.inner|0);case s.BinOperator.Sub:return B(e.inner-r.inner|0);case s.BinOperator.Mul:return B(e.inner*r.inner|0);case s.BinOperator.Div:return r.inner===0?Y:B(Math.floor(e.inner/r.inner));case s.BinOperator.Lt:return B(A(e.inner<r.inner));case s.BinOperator.Leq:return B(A(e.inner<=r.inner));case s.BinOperator.Gt:return B(A(e.inner>r.inner));case s.BinOperator.Geq:return B(A(e.inner>=r.inner));case s.BinOperator.Eq:return B(A(e.inner===r.inner));case s.BinOperator.Neq:return B(A(e.inner!==r.inner));default:f(0,`Invalid binary operator ${n}`)}return Y}uopC(e,n){if(n.kind==="Nac")return K;if(n.kind==="Undef")return Y;if(n.kind==="Constant")switch(e){case s.UnOperator.Neg:return B(-n.inner|0);case s.UnOperator.Not:return B(A(!n.inner));case s.UnOperator.UPlus:return B(+n.inner|0);default:f(0,`Invalid unary operator ${e}`)}return Y}findC(e,n){const r=S(n.get(e));return r===void 0&&f(0,`Cannot access C of ${e}`),r}transfer(e,n){const r=this.cfg.getInstr(e);switch(r.kind){case"Alloc":case"LoadByte":case"LoadWord":case"Call":{const a=S(n);return a.set(r.dest,K),a}case"BinOp":if(r.right1.kind==="Reg"&&r.right2.kind==="Reg"){const a=this.findC(r.right1.name,n),i=this.findC(r.right2.name,n),o=S(n);return o.set(r.left,this.bopC(a,r.op,i)),o}else if(r.right1.kind==="Reg"&&r.right2.kind==="Imm"){const a=this.findC(r.right1.name,n),i=S(n);return i.set(r.left,this.bopC(a,r.op,B(r.right2.value))),i}else if(r.right1.kind==="Imm"&&r.right2.kind==="Reg"){const a=this.findC(r.right2.name,n),i=S(n);return i.set(r.left,this.bopC(B(r.right1.value),r.op,a)),i}else if(r.right1.kind==="Imm"&&r.right2.kind==="Imm"){const a=S(n);return a.set(r.left,this.bopC(B(r.right1.value),r.op,B(r.right2.value))),a}else f(0,"Unexpected operand for binop");case"UnOp":if(r.right.kind==="Reg"){const a=this.findC(r.right.name,n),i=S(n);return i.set(r.left,this.uopC(r.op,a)),i}else if(r.right.kind==="Imm"){const a=S(n);return a.set(r.left,this.uopC(r.op,B(r.right.value))),a}else f(0,"Unexpected operand for unop");case"Set":if(r.right.kind==="Reg"){const a=this.findC(r.right.name,n),i=S(n);return i.set(r.left,a),i}else{const a=S(n);return a.set(r.left,B(r.right.value)),a}case"Print":if(r.operand.kind==="Reg"){const a=this.findC(r.operand.name,n),i=S(n);return i.set(r.dest,a),i}else{const a=S(n);return a.set(r.dest,B(r.operand.value)),a}case"StoreByte":case"StoreWord":case"Goto":case"GotoF":case"GotoT":case"Label":case"FnDecl":case"Halt":case"Ret":return S(n);default:w(r)}}getInOut(){for(let n=0;n<this.cfg.code.length;n++)this.inSets[n]=this.initialD(),this.outSets[n]=this.initialD();let e=!0;for(;e;){e=!1;for(let n=0;n<this.cfg.code.length;n++){const r=S(this.inSets[n]),a=S(this.outSets[n]);this.inSets[n]=this.initialD();const i=this.cfg.getPreds(n);if(i)for(const o of i){const d=this.outSets[o];this.inSets[n]=this.joinD(this.inSets[n],d)}this.outSets[n]=this.transfer(n,this.inSets[n]),(!pe(this.outSets[n],a)||!pe(this.inSets[n],r))&&(e=!0)}}return[this.inSets,this.outSets]}}function Gi(t){return(t>>>0).toString(16).padStart(8,"0")}function qi(t){return((t&255)>>>0).toString(16).padStart(2,"0")}class Vi{memory;constructor(){this.memory=[]}allocate(e){const n=this.memory.length;for(let r=0;r<e;r++)this.memory.push("00");return n}storeByte(e,n){this.memory[e]=qi(n)}loadByte(e){return parseInt(this.memory[e],16)<<24>>24}storeWord(e,n){const r=Gi(n),a=[r.slice(6,8),r.slice(4,6),r.slice(2,4),r.slice(0,2)];for(let i=0;i<4;i++)this.memory[e+i]=a[i]}loadWord(e){let n="";for(let a=0;a<4;a++)n+=this.memory[e+a];const r=n.slice(6,8)+n.slice(4,6)+n.slice(2,4)+n.slice(0,2);return parseInt(r,16)|0}}let Se=(t,e)=>({functionName:t,index:e});class Wi{constructor(e,n,r){this.code=e,this.functionRegistry=n,this.onPrint=r,this.memory=new Vi,this.pc=Se(void 0,0),this.returnAddrStack=[],this.returnRegStack=[],this.envStack=[],this.currentEnv=new Map}memory;pc;returnAddrStack;returnRegStack;envStack;currentEnv;fetchInstr(){const e=this.pc.functionName,n=this.pc.index;if(e===void 0)return this.code[n];{const r=this.functionRegistry.get(e);return r===void 0&&f(this.pc.index,`Function ${e} not in registry`),r.kind!=="FnDecl"&&f(this.pc.index,`Non FnDecl ${e} in registry`),r.body[n]}}lookupReg(e){const n=this.currentEnv.get(e);return n===void 0&&f(this.pc.index,`Failed to get value of register ${e}`),n}getOperandValue(e){switch(e.kind){case"Imm":return e.value;case"Reg":return this.lookupReg(e.name);default:w(e)}}execute(){for(;;){const e=this.fetchInstr();switch(e.kind){case"Set":{this.currentEnv.set(e.left,this.getOperandValue(e.right)),this.pc.index++;break}case"Alloc":{const n=this.getOperandValue(e.operand),r=this.memory.allocate(n);this.currentEnv.set(e.dest,r),this.pc.index++;break}case"BinOp":{const n=this.getOperandValue(e.right1),r=this.getOperandValue(e.right2);switch(e.op){case s.BinOperator.Add:this.currentEnv.set(e.left,n+r|0);break;case s.BinOperator.Sub:this.currentEnv.set(e.left,n-r|0);break;case s.BinOperator.Mul:this.currentEnv.set(e.left,n*r|0);break;case s.BinOperator.Div:this.currentEnv.set(e.left,Math.floor(n/r));break;case s.BinOperator.Lt:this.currentEnv.set(e.left,A(n<r));break;case s.BinOperator.Leq:this.currentEnv.set(e.left,A(n<=r));break;case s.BinOperator.Gt:this.currentEnv.set(e.left,A(n>r));break;case s.BinOperator.Geq:this.currentEnv.set(e.left,A(n>=r));break;case s.BinOperator.Eq:this.currentEnv.set(e.left,A(n===r));break;case s.BinOperator.Neq:this.currentEnv.set(e.left,A(n!==r));break}this.pc.index++;break}case"UnOp":{const n=this.getOperandValue(e.right);switch(e.op){case s.UnOperator.Neg:this.currentEnv.set(e.left,-n);break;case s.UnOperator.UPlus:this.currentEnv.set(e.left,+n);break;case s.UnOperator.Not:this.currentEnv.set(e.left,A(!n));break}this.pc.index++;break}case"LoadByte":{const n=this.memory.loadByte(this.lookupReg(e.src));this.currentEnv.set(e.dest,n),this.pc.index++;break}case"LoadWord":{const n=this.memory.loadWord(this.lookupReg(e.src));this.currentEnv.set(e.dest,n),this.pc.index++;break}case"StoreByte":{const n=this.getOperandValue(e.src);this.memory.storeByte(this.lookupReg(e.dest),n),this.pc.index++;break}case"StoreWord":{const n=this.getOperandValue(e.src);this.memory.storeWord(this.lookupReg(e.dest),n),this.pc.index++;break}case"Goto":{typeof e.dest=="string"&&f(this.pc.index,"Label was not resolved."),this.pc.index=e.dest;break}case"GotoT":{const n=this.getOperandValue(e.cond);typeof e.dest=="string"&&f(this.pc.index,"Label was not resolved."),n?this.pc.index=e.dest:this.pc.index++;break}case"GotoF":{const n=this.getOperandValue(e.cond);typeof e.dest=="string"&&f(this.pc.index,"Label was not resolved."),n?this.pc.index++:this.pc.index=e.dest;break}case"Print":{const n=this.getOperandValue(e.operand);this.currentEnv.set(e.dest,n),this.onPrint===void 0?console.log(n):this.onPrint(n.toString()),this.pc.index++;break}case"Call":{const n=this.functionRegistry.get(e.calleeName);n===void 0&&f(this.pc.index,`Cannot find function ${e.calleeName} in registry`),n.kind!=="FnDecl"&&f(this.pc.index,`Non function ${e.calleeName} in registry`),this.envStack.push(this.currentEnv),this.returnAddrStack.push(Se(this.pc.functionName,this.pc.index+1)),this.returnRegStack.push(e.dest);const r=new Map;for(let a=0;a<n.args.length;a++){const i=n.args[a],o=this.getOperandValue(e.args[a]);r.set(i,o)}this.pc=Se(e.calleeName,0),this.currentEnv=r;break}case"Ret":{const n=this.getOperandValue(e.operand),r=this.envStack.pop(),a=this.returnRegStack.pop(),i=this.returnAddrStack.pop();(r===void 0||a===void 0||i===void 0)&&f(this.pc.index,"Tried to return outside any function."),this.currentEnv=r,this.currentEnv.set(a,n),this.pc=i;break}case"Halt":return;case"FnDecl":case"Label":this.pc.index++;break;default:w(e)}}}}var Re;(t=>{function e(r,a){for(const i of r)i.kind==="FnDecl"&&(a.set(i.name,i),e(i.body,a))}function n(r){const a=new Map;return e(r,a),a}t.createRegistry=n})(Re||(Re={}));class P{constructor(e){this.parent=e}values=new Map;define(e,n){this.values.set(e,n)}lookup(e){return this.values.has(e)?this.values.get(e):this.parent?.lookup(e)}lookupCurrentScope(e){if(this.values.has(e))return this.values.get(e)}}var ge;(t=>{let e=0;function n(){e=0}t.resetFunctionUid=n;function r(l){return`${l}_#${e++}`}function a(l,g){for(const p of l)if(p.kind==="FnDecl"){const m=r(p.name);g.define(p.name,m),p.name=m}return g}function i(l,g){switch(l.kind){case"Call":{const p=g.lookup(l.calleeName);p!==void 0&&(l.calleeName=p);for(const m of l.args)i(m,g);break}case"Assign":i(l.expr,g);break;case"UnOp":i(l.operand,g);break;case"Cast":i(l.left,g);break;case"Deref":i(l.operand,g);break;case"BinOp":{i(l.left,g),i(l.right,g);break}case"PtrUpdate":{i(l.left,g),i(l.right,g);break}case"AddrOf":case"Const":case"Var":break;default:w(l)}}function o(l,g){switch(l.kind){case"FnDecl":{const p=new P(g);o(l.body,p);break}case"Block":{const p=new P(g);d(l.stmts,p);break}case"If":{i(l.cond,g);const p=new P(g);o(l.true_arm,p);const m=new P(g);o(l.false_arm,m);break}case"While":{i(l.cond,g);const p=new P(g);o(l.body,p);break}case"ExprStmt":i(l.expr,g);break;case"VarDecl":i(l.expr,g);break;case"Return":i(l.expr,g);break;case"Break":case"Continue":break;default:w(l)}}function d(l,g){g=a(l,g);for(let p of l)o(p,g)}t.traverseStmts=d;function c(l){d(l,new P(void 0))}t.traverse=c})(ge||(ge={}));var Ie;(t=>{function e(r){const a=new Map;for(let i=0;i<r.length;i++){const o=r[i];o.kind==="Label"&&a.set(o.label,i)}return a}function n(r){const a=e(r);for(let i=0;i<r.length;i++){const o=r[i];switch(o.kind){case"FnDecl":n(o.body);break;case"GotoT":{if(typeof o.dest=="string"&&a.has(o.dest)){const d=a.get(o.dest);d===void 0&&f(i,`Destination label of ${o.kind} not resolved.`),o.dest=d}break}case"GotoF":{if(typeof o.dest=="string"&&a.has(o.dest)){const d=a.get(o.dest);d===void 0&&f(i,`Destination label of ${o.kind} not resolved.`),o.dest=d}break}case"Goto":{if(typeof o.dest=="string"&&a.has(o.dest)){const d=a.get(o.dest);d===void 0&&f(i,`Destination label of ${o.kind} not resolved.`),o.dest=d}break}case"Alloc":case"BinOp":case"Call":case"Label":case"LoadByte":case"LoadWord":case"Ret":case"Set":case"StoreByte":case"StoreWord":case"UnOp":case"Print":case"Halt":break;default:w(o)}}return r}t.resolveLabels=n})(Ie||(Ie={}));class xi{inSets;outSets;cfg;constructor(e){this.cfg=new Ct(e),this.inSets=[],this.outSets=[]}getDefOfInstr(e){switch(e.kind){case"Alloc":return new Set([e.dest]);case"BinOp":return new Set([e.left]);case"Call":return new Set([e.dest]);case"LoadWord":case"LoadByte":return new Set([e.dest]);case"Print":return new Set([e.dest]);case"Set":return new Set([e.left]);case"UnOp":return new Set([e.left]);case"FnDecl":case"Goto":case"GotoF":case"GotoT":case"Halt":case"Label":case"Ret":case"StoreByte":case"StoreWord":return new Set;default:w(e)}}getUseOfInstr(e){switch(e.kind){case"Alloc":return e.operand.kind==="Reg"?new Set([e.operand.name]):new Set;case"BinOp":{const n=new Set;return e.right1.kind==="Reg"&&n.add(e.right1.name),e.right2.kind==="Reg"&&n.add(e.right2.name),n}case"UnOp":return e.right.kind==="Reg"?new Set([e.right.name]):new Set;case"Set":return e.right.kind==="Reg"?new Set([e.right.name]):new Set;case"LoadByte":case"LoadWord":return new Set([e.src]);case"StoreByte":case"StoreWord":{const n=new Set;return n.add(e.dest),e.src.kind==="Reg"&&n.add(e.src.name),n}case"GotoF":case"GotoT":return e.cond.kind==="Reg"?new Set([e.cond.name]):new Set;case"Call":{const n=new Set;for(const r of e.args)r.kind==="Reg"&&n.add(r.name);return n}case"Print":return e.operand.kind==="Reg"?new Set([e.operand.name]):new Set;case"Ret":return e.operand.kind==="Reg"?new Set([e.operand.name]):new Set;case"FnDecl":case"Goto":case"Halt":case"Label":return new Set;default:w(e)}}transfer(e,n){const r=this.cfg.getInstr(n),a=this.getDefOfInstr(r),i=this.getUseOfInstr(r);return dt(ji(e,a),i)}getInOut(){for(let n=0;n<this.cfg.code.length;n++)this.inSets[n]=new Set;let e=!0;for(;e;){e=!1;for(let n=this.cfg.code.length-1;n>=0;n--){const r=S(this.inSets[n]),a=this.cfg.getSuccs(n);let i=new Set;for(const o of a){const d=this.inSets[o];i=dt(i,d)}this.outSets[n]=i,this.inSets[n]=this.transfer(this.outSets[n],n),pe(this.inSets[n],r)||(e=!0)}}return[this.inSets,this.outSets]}}var Ce;(t=>{function e(a){const i=new Set;return a.filter(o=>o.kind==="Alloc").map(o=>o.dest).forEach(o=>{i.add(o)}),i}function n(a){const i=e(a);for(const o of a)switch(o.kind){case"Alloc":{o.operand.kind==="Reg"&&i.delete(o.operand.name);break}case"Set":{o.right.kind==="Reg"&&i.delete(o.right.name);break}case"BinOp":{o.right1.kind==="Reg"&&i.delete(o.right1.name),o.right2.kind==="Reg"&&i.delete(o.right2.name);break}case"UnOp":{o.right.kind==="Reg"&&i.delete(o.right.name);break}case"Call":{for(const d of o.args)d.kind==="Reg"&&i.delete(d.name);break}case"GotoT":case"GotoF":{o.cond.kind==="Reg"&&i.delete(o.cond.name);break}case"Ret":{o.operand.kind==="Reg"&&i.delete(o.operand.name);break}case"Print":{o.operand.kind==="Reg"&&i.delete(o.operand.name);break}case"LoadByte":case"LoadWord":{i.has(o.dest)&&i.delete(o.dest);break}case"StoreByte":case"StoreWord":{o.src.kind==="Reg"&&i.delete(o.src.name);break}}return i}function r(a){const i=n(a),o=[];for(const d of a)switch(d.kind){case"Alloc":{if(i.has(d.dest))break;o.push(d);break}case"StoreByte":case"StoreWord":{if(i.has(d.dest)){o.push(s.Set(d.dest,d.src));break}o.push(d);break}case"LoadByte":case"LoadWord":{if(i.has(d.src)){o.push(s.Set(d.dest,s.Reg(d.src)));break}o.push(d);break}default:o.push(d)}return o}t.mem2Reg=r})(Ce||(Ce={}));var Ne;(t=>{function e(n){const r=new xi(n),[a,i]=r.getInOut(),o=[];for(let d=0;d<n.length;d++){const c=n[d],l=r.getDefOfInstr(c),g=i[d];if(l.size===0)o.push(c);else if(c.kind==="Print")o.push(c);else if(c.kind==="Call")o.push(c);else for(const p of l)if(g.has(p)){o.push(c);break}}return o}t.dce=e})(Ne||(Ne={}));var Te;(t=>{function e(n){const r=new Ui(n),[a,i]=r.getInOut(),o=[];for(let d=0;d<n.length;d++){const c=n[d],l=a[d],g=i[d];switch(c.kind){case"Alloc":{if(c.operand.kind==="Reg"){const p=l.get(c.operand.name);p.kind==="Constant"?o.push(s.Alloc(c.dest,s.Imm(p.inner))):o.push(c)}else o.push(c);break}case"BinOp":{let p=c.right1,m=c.right2;if(c.right1.kind==="Reg"){const v=l.get(c.right1.name);v.kind==="Constant"&&(p=s.Imm(v.inner))}if(c.right2.kind==="Reg"){const v=l.get(c.right2.name);v.kind==="Constant"&&(m=s.Imm(v.inner))}const y=g.get(c.left);y.kind==="Constant"?o.push(s.Set(c.left,s.Imm(y.inner))):o.push(s.BinOp(c.left,c.op,p,m));break}case"UnOp":{const p=g.get(c.left);p.kind==="Constant"?o.push(s.Set(c.left,s.Imm(p.inner))):o.push(c);break}case"Call":{const p=[];for(const m of c.args)if(m.kind==="Reg"){const y=l.get(m.name);y.kind==="Constant"?p.push(s.Imm(y.inner)):p.push(m)}else p.push(m);o.push(s.Call(c.dest,c.calleeName,p));break}case"Print":{if(c.operand.kind==="Reg"){const p=l.get(c.operand.name);p.kind==="Constant"?o.push(s.Print(c.dest,s.Imm(p.inner))):o.push(c)}else o.push(c);break}case"Ret":{if(c.operand.kind==="Reg"){const p=l.get(c.operand.name);p.kind==="Constant"?o.push(s.Ret(s.Imm(p.inner))):o.push(c)}else o.push(c);break}case"Set":{const p=g.get(c.left);p.kind==="Constant"?o.push(s.Set(c.left,s.Imm(p.inner))):o.push(c);break}case"StoreByte":case"StoreWord":{const p=c.kind==="StoreByte";if(c.src.kind==="Reg"){const m=l.get(c.src.name);if(m.kind==="Constant"){const y=s.Imm(m.inner);o.push(p?s.StoreByte(y,c.dest):s.StoreWord(y,c.dest))}else o.push(c)}else o.push(c);break}case"GotoT":{if(c.cond.kind==="Reg"){const p=l.get(c.cond.name);p.kind==="Constant"?p.inner!==0&&o.push(s.Goto(c.dest)):o.push(c)}else c.cond.value!==0&&o.push(s.Goto(c.dest));break}case"GotoF":{if(c.cond.kind==="Reg"){const p=l.get(c.cond.name);p.kind==="Constant"?p.inner===0&&o.push(s.Goto(c.dest)):o.push(c)}else c.cond.value===0&&o.push(s.Goto(c.dest));break}default:o.push(c)}}return o}t.cp=e})(Te||(Te={}));function Nt(t){let e=Ce.mem2Reg(t);e=Ne.dce(e),e=Te.cp(e);for(let n=0;n<e.length;n++){const r=e[n];r.kind==="FnDecl"&&(e[n]=s.FnDecl(r.name,r.args,Nt(r.body)))}return e}function Hi(t){let e=S(t),n=[];for(;;){if(n=Nt(e),pe(e,n))return e;e=S(n)}}var u=(t=>(t.LParen="LParen",t.RParen="RParen",t.LBrace="LBrace",t.RBrace="RBrace",t.Plus="Plus",t.Minus="Minus",t.Star="Star",t.Slash="Slash",t.True="True",t.False="False",t.Identifier="Identifier",t.Number="Number",t.Let="Let",t.As="As",t.Alloc="Alloc",t.Print="Print",t.If="If",t.Else="Else",t.While="While",t.Fn="Fn",t.Bang="Bang",t.Semicolon="Semicolon",t.Colon="Colon",t.Comma="Comma",t.Equal="Equal",t.EqualEqual="EqualEqual",t.BangEqual="BangEqual",t.Less="Less",t.LessEqual="LessEqual",t.Greater="Greater",t.GreaterEqual="GreaterEqual",t.AmpAmp="AmpAmp",t.Ampersan="Ampersan",t.VertBarVertBar="VertBarVertBar",t.Return="Return",t.Break="Break",t.Continue="Continue",t.Int="Int",t.Bool="Bool",t.Ptr="Ptr",t.Eof="Eof",t))(u||{});class ft{constructor(e,n,r){this.lineNum=e,this.type=n,this.value=r}toString(){return this.value!==void 0?`${this.type}(${this.value})`:this.type}}class zi{constructor(e){this.tokens=e,this.current=0,this.previous=0}current;previous;parse(){let e=[];for(;!this.match([u.Eof]);)e.push(this.statement());return e}statement(){return this.match([u.If])?this.if_statement():this.match([u.While])?this.while_statement():this.match([u.Fn])?this.fn_decl():this.match([u.Return])?this.return_statement():this.match([u.Break])?this.break_statement():this.match([u.Continue])?this.continue_statement():this.match([u.Let])?this.vardecl_statement():this.match([u.LBrace])?this.block_statement():this.expression_statement()}vardecl_statement(){this.eat(u.Identifier);let e=this.peekPrevious().value;typeof e!="string"&&f(this.peekPrevious().lineNum,`Invalid variable name ${e}`),this.eat(u.Colon);let n=this.type();this.eat(u.Equal);let r=this.expression();return this.eat(u.Semicolon),b.VarDecl(this.peekPrevious().lineNum,we(e,n),r)}if_statement(){let e=this.expression(),n=this.peekPrevious().lineNum,r=this.statement();if(this.match([u.Else])){let a=this.statement();return b.If(n,e,r,a)}return b.If(n,e,r,b.ExprStmt(this.peekPrevious().lineNum,b.Const(this.peekPrevious().lineNum,0)))}while_statement(){let e=this.expression(),n=this.peekPrevious().lineNum,r=this.statement();return b.While(n,e,r)}fn_decl(){this.eat(u.Identifier);let e=this.peekPrevious().lineNum,n=this.peekPrevious().value;typeof n!="string"&&f(this.peekPrevious().lineNum,`Invalid function name ${n}`),this.eat(u.LParen);let r=this.fn_args();this.eat(u.Colon);let a=this.type(),i=this.statement();return b.FnDecl(e,n,r,i,a)}fn_args(){if(this.match([u.RParen]))return[];this.eat(u.Identifier);let e=this.peekPrevious().value;typeof e!="string"&&f(this.peekPrevious().lineNum,`Invalid parameter name ${e}`),this.eat(u.Colon);let n=this.type(),r=[we(e,n)];for(;this.match([u.Comma]);){this.eat(u.Identifier);let a=this.peekPrevious().value;typeof a!="string"&&f(this.peekPrevious().lineNum,`Invalid parameter name ${a}`),this.eat(u.Colon);let i=this.type();r.push(we(a,i))}return this.eat(u.RParen),r}block_statement(){let e=[];for(;!this.match([u.RBrace,u.Eof]);)e.push(this.statement());return this.peekPrevious().type!==u.RBrace&&f(this.peekPrevious().lineNum,"Couldn't close braces"),b.Block(this.peekPrevious().lineNum,e)}return_statement(){let e=this.expression();return this.eat(u.Semicolon),b.Return(this.peekPrevious().lineNum,e)}break_statement(){return this.eat(u.Semicolon),b.Break(this.peekPrevious().lineNum)}continue_statement(){return this.eat(u.Semicolon),b.Continue(this.peekPrevious().lineNum)}expression_statement(){let e=this.expression();return this.eat(u.Semicolon),b.ExprStmt(this.peekPrevious().lineNum,e)}expression(){return this.assignment()}assignment(){let e=this.logical();return this.match([u.Equal])&&(e.kind==="Var"?e=b.Assign(this.peekPrevious().lineNum,e.name,this.assignment()):e.kind==="Deref"?e=b.PtrUpdate(this.peekPrevious().lineNum,e.operand,this.assignment()):f(this.peekPrevious().lineNum,`Invalid target for assignment ${b.stringOfExpr(e)}.`)),e}logical(){let e=this.equality();for(;this.match([u.AmpAmp,u.VertBarVertBar]);)e=b.BinOp(this.peekPrevious().lineNum,e,this.peekPrevious().type,this.equality());return e}equality(){let e=this.comparison();for(;this.match([u.EqualEqual,u.BangEqual]);)e=b.BinOp(this.peekPrevious().lineNum,e,this.peekPrevious().type,this.comparison());return e}comparison(){let e=this.term();for(;this.match([u.Less,u.LessEqual,u.Greater,u.GreaterEqual]);)e=b.BinOp(this.peekPrevious().lineNum,e,this.peekPrevious().type,this.term());return e}term(){let e=this.factor();for(;this.match([u.Plus,u.Minus]);)e=b.BinOp(this.peekPrevious().lineNum,e,this.peekPrevious().type,this.factor());return e}factor(){let e=this.cast();for(;this.match([u.Star,u.Slash]);)e=b.BinOp(this.peekPrevious().lineNum,e,this.peekPrevious().type,this.cast());return e}cast(){let e=this.unary();for(;this.match([u.As]);){let n=this.type();e=b.Cast(this.peekPrevious().lineNum,e,n)}return e}unary(){if(this.match([u.Minus,u.Plus,u.Bang,u.Alloc,u.Print]))return b.UnOp(this.peekPrevious().lineNum,this.peekPrevious().type,this.unary());if(this.match([u.Star]))return b.Deref(this.peekPrevious().lineNum,this.unary());if(this.match([u.Ampersan])){this.eat(u.Identifier);let e=this.peekPrevious().value;return typeof e!="string"&&f(this.peekPrevious().lineNum,`Expected variable name as operand of & but got ${e}`),b.AddrOf(this.peekPrevious().lineNum,e)}return this.call()}call(){let e=this.primary();return this.match([u.LParen])&&(e.kind==="Var"?e=b.Call(this.peekPrevious().lineNum,e.name,this.callArgs()):f(this.peekPrevious().lineNum,`Invalid target to call ${b.stringOfExpr(e)}.`)),e}callArgs(){if(this.match([u.RParen]))return[];let e=[this.expression()];for(;this.match([u.Comma]);){let n=this.expression();e.push(n)}return this.eat(u.RParen),e}primary(){if(this.match([u.True]))return b.Const(this.peekPrevious().lineNum,!0);if(this.match([u.False]))return b.Const(this.peekPrevious().lineNum,!1);if(this.match([u.Number])){let e=this.peekPrevious().value;return typeof e!="number"&&f(this.peekPrevious().lineNum,`Number expected to have value of number but has ${e}`),b.Const(this.peekPrevious().lineNum,e)}if(this.match([u.Identifier])){let e=this.peekPrevious().value;return typeof e!="string"&&f(this.peekPrevious().lineNum,`Identifier expected to have value of string but has ${e}`),b.Var(this.peekPrevious().lineNum,e)}if(this.match([u.LParen])){let e=this.expression();return this.eat(u.RParen),e}f(this.peek().lineNum,`Unexpected symbol ${this.peek()}`)}type(){return this.type_ptr()}type_ptr(){if(this.match([u.Ptr])){this.eat(u.Less);let e=this.type();return this.eat(u.Greater),h.Ptr(e)}return this.type_primary()}type_primary(){if(this.match([u.Int]))return h.Int;if(this.match([u.Bool]))return h.Bool;f(this.peek().lineNum,`Invalid type symbol ${this.peek()}`)}advance(){return this.tokens[this.current++]}peek(){return this.tokens[this.current]}peekPrevious(){return this.tokens[this.current-1]}match(e){for(const n of e)if(this.peek().type===n)return this.advance(),!0;return!1}eat(e){if(this.peek().type===e){this.advance();return}f(this.peek().lineNum,`Expected ${e}, but got ${this.peek()}`)}}var Le;(t=>{function e(i){n(i)}t.check=e;function n(i){for(const o of i)r(o)}function r(i){switch(i.kind){case"If":{r(i.true_arm),r(i.false_arm);break}case"While":r(i.body);break;case"Block":n(i.stmts);break;case"FnDecl":{a(i.body)||f(i.lineNum,`Function ${i.name} might not return.`),r(i.body);break}case"Break":case"Continue":case"ExprStmt":case"VarDecl":case"Return":break;default:w(i)}}function a(i){switch(i.kind){case"Return":return!0;case"If":return a(i.true_arm)&&a(i.false_arm);case"While":return i.cond.kind==="Const"&&i.cond.value===!0?a(i.body):!1;case"Block":{for(const o of i.stmts)if(a(o))return!0;return!1}case"Break":case"Continue":case"ExprStmt":case"VarDecl":case"FnDecl":return!1;default:return!1}}})(Le||(Le={}));class me{constructor(e){this.source=e,this.current=0,this.start=0,this.line=1,this.tokens=[]}current;start;tokens;line;static keywords=new Map([["int",u.Int],["bool",u.Bool],["ptr",u.Ptr],["let",u.Let],["as",u.As],["alloc",u.Alloc],["if",u.If],["else",u.Else],["fn",u.Fn],["true",u.True],["false",u.False],["while",u.While],["return",u.Return],["break",u.Break],["continue",u.Continue],["print",u.Print]]);tokenizeAll(){for(;!this.isEnd();)this.start=this.current,this.tokenize();return this.appendToken(u.Eof),this.tokens}tokenize(){let e=this.advance();switch(e){case"(":this.appendToken(u.LParen);break;case")":this.appendToken(u.RParen);break;case"{":this.appendToken(u.LBrace);break;case"}":this.appendToken(u.RBrace);break;case",":this.appendToken(u.Comma);break;case";":this.appendToken(u.Semicolon);break;case":":this.appendToken(u.Colon);break;case"+":this.appendToken(u.Plus);break;case"-":this.appendToken(u.Minus);break;case"*":this.appendToken(u.Star);break;case`
`:this.line++;break;case"	":case" ":case"\r":break;case"!":this.match("=")?this.appendToken(u.BangEqual):this.appendToken(u.Bang);break;case"=":this.match("=")?this.appendToken(u.EqualEqual):this.appendToken(u.Equal);break;case"<":this.match("=")?this.appendToken(u.LessEqual):this.appendToken(u.Less);break;case">":this.match("=")?this.appendToken(u.GreaterEqual):this.appendToken(u.Greater);break;case"/":if(this.match("*"))for(;!this.isEnd()&&!(this.match("*")&&this.match("/"));)this.advance();else if(this.match("/"))for(;!this.isEnd()&&!this.match(`
`);)this.advance();else this.appendToken(u.Slash);break;case"&":this.match("&")?this.appendToken(u.AmpAmp):this.appendToken(u.Ampersan);break;case"|":this.match("|")?this.appendToken(u.VertBarVertBar):f(this.line,"Expected '|' after '|'.");break;default:if(this.isDigit(e)){for(;!this.isEnd()&&this.isDigit(this.peek());)this.current++;let n=this.source.slice(this.start,this.current),r=parseInt(n);this.appendToken(u.Number,r)}else if(this.isAlpha(e)){for(;!this.isEnd()&&this.isAlphaNumeric(this.peek());)this.current++;let n=this.source.slice(this.start,this.current);me.keywords.has(n)?this.appendToken(me.keywords.get(n)):this.appendToken(u.Identifier,n)}else f(this.line,`Unexpected character ${this.peek()}.`);break}}advance(){return this.source[this.current++]}peek(){return this.source[this.current]}isEnd(){return this.current>=this.source.length}isDigit(e){return e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57}isAlpha(e){let n=e.charCodeAt(0);return n>=97&&n<=122||n>=65&&n<=90||n===95}isAlphaNumeric(e){return this.isDigit(e)||this.isAlpha(e)}match(e){return this.peek()===e?(this.advance(),!0):!1}eat(e){if(this.peek()===e){this.advance();return}f(this.line,`Expected ${e} but got ${this.peek()}`)}appendToken(e,n){n===void 0?this.tokens.push(new ft(this.line,e)):this.tokens.push(new ft(this.line,e,n))}printTokens(){for(let e=0;e<this.tokens.length;e++){const n=this.tokens[e];console.log(n.toString())}}}class De{constructor(e){this.parent=e}condLabel;exitLabel;defineCondLabel(e){this.condLabel=e}defineExitLabel(e){this.exitLabel=e}getCondLabel(){return this.condLabel!==void 0?this.condLabel:this.parent?.getCondLabel()}getExitLabel(){return this.exitLabel!==void 0?this.exitLabel:this.parent?.getExitLabel()}}function _(t,e){switch(t.kind){case"Const":if(typeof t.value=="number"){const n=E();return[n,[s.Set(n,s.Imm(t.value))],h.Int]}else{let n=0;t.value&&(n=1);const r=E();return[r,[s.Set(r,s.Imm(n))],h.Bool]}case"Var":{const[n,r]=e.lookup(t.name),a=E(),i=h.toArth(r);switch(r.kind){case"Ptr":case"Int":return[a,[s.LoadWord(a,n)],i];case"Bool":return[a,[s.LoadByte(a,n)],i];case"Func":f(t.lineNum,`Typecheck fail: Invalid generation of ${h.stringOfType(r)}. You mustn't be here`);default:w(r)}}case"AddrOf":{const[n,r]=e.lookup(t.operand),a=E(),i=h.toArth(r);return[a,[s.Set(a,s.Reg(n))],k.Ptr(i)]}case"Deref":{const[n,r,a]=_(t.operand,e),i=E();if(h.isEqual(a,h.Ptr(h.Int)))return[i,[...r,s.LoadWord(i,n)],k.Int];if(h.isEqual(a,h.Ptr(h.Bool)))return[i,[...r,s.LoadByte(i,n)],k.Bool];if(a.kind==="Ptr")return[i,[...r,s.LoadWord(i,n)],a.inner];f(t.lineNum,`Typecheck fail: Invalid derefernce of ${h.stringOfType(a)}. You mustn't be here`)}case"PtrUpdate":{const[n,r,a]=_(t.left,e),[i,o,d]=_(t.right,e),c=E();let l;return h.isEqual(a,k.Ptr(h.Int))?l=s.StoreWord(s.Reg(i),n):h.isEqual(a,k.Ptr(h.Bool))?l=s.StoreByte(s.Reg(i),n):a.kind==="Ptr"?l=s.StoreWord(s.Reg(i),n):f(t.lineNum,`Typecheck fail: Invalid ptr update of ${h.stringOfType(a)}. You mustn't be here`),[c,[...r,...o,l,s.Set(c,s.Reg(i))],d]}case"Assign":{const[n,r,a]=_(t.expr,e),i=E(),[o,d]=e.lookup(t.name);switch(d.kind){case"Bool":return[i,[...r,s.StoreByte(s.Reg(n),o),s.Set(i,s.Reg(n))],a];case"Int":case"Ptr":return[i,[...r,s.StoreWord(s.Reg(n),o),s.Set(i,s.Reg(n))],a]}f(t.lineNum,`Typecheck fail: Invalid assignment translation of ${h.stringOfType(d)}. You mustn't be here`)}case"BinOp":{const[n,r,a]=_(t.left,e),[i,o,d]=_(t.right,e),c=E();switch(t.op){case u.Plus:{if(k.isEqual(a,d)&&k.isEqual(a,h.Int))return[c,[...r,...o,s.BinOp(c,s.BinOperator.Add,s.Reg(n),s.Reg(i))],a];if(a.kind==="Ptr"&&d.kind==="Int"){if(a.inner.kind==="Bool")return[c,[...r,...o,s.BinOp(c,s.BinOperator.Add,s.Reg(n),s.Reg(i))],a];const l=E();return[c,[...r,...o,s.BinOp(l,s.BinOperator.Mul,s.Reg(i),s.Imm(4)),s.BinOp(c,s.BinOperator.Add,s.Reg(n),s.Reg(l))],a]}if(d.kind==="Ptr"&&a.kind==="Int"){if(d.inner.kind==="Bool")return[c,[...r,...o,s.BinOp(c,s.BinOperator.Add,s.Reg(n),s.Reg(i))],d];const l=E();return[c,[...r,...o,s.BinOp(l,s.BinOperator.Mul,s.Reg(n),s.Imm(4)),s.BinOp(c,s.BinOperator.Add,s.Reg(i),s.Reg(l))],d]}f(t.lineNum,`Typecheck fail: Invalid Add operation of ${h.stringOfType(a)} and ${h.stringOfType(d)}`)}case u.Minus:{if(k.isEqual(a,d)&&k.isEqual(a,h.Int))return[c,[...r,...o,s.BinOp(c,s.BinOperator.Sub,s.Reg(n),s.Reg(i))],a];if(a.kind==="Ptr"&&d.kind==="Int"){if(a.inner.kind==="Bool")return[c,[...r,...o,s.BinOp(c,s.BinOperator.Sub,s.Reg(n),s.Reg(i))],a];const l=E();return[c,[...r,...o,s.BinOp(l,s.BinOperator.Mul,s.Reg(i),s.Imm(4)),s.BinOp(c,s.BinOperator.Sub,s.Reg(n),s.Reg(l))],a]}if(k.isEqual(a,d)&&a.kind==="Ptr"){if(a.inner.kind==="Bool")return[c,[...r,...o,s.BinOp(c,s.BinOperator.Sub,s.Reg(n),s.Reg(i))],k.Int];const l=E();return[c,[...r,...o,s.BinOp(l,s.BinOperator.Sub,s.Reg(n),s.Reg(i)),s.BinOp(c,s.BinOperator.Div,s.Reg(l),s.Imm(4))],k.Int]}f(t.lineNum,`Typecheck fail: Invalid Sub operation of ${h.stringOfType(a)} and ${h.stringOfType(d)}`)}case u.Star:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Mul,s.Reg(n),s.Reg(i))],k.Int];case u.Slash:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Div,s.Reg(n),s.Reg(i))],k.Int];case u.Less:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Lt,s.Reg(n),s.Reg(i))],k.Bool];case u.LessEqual:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Leq,s.Reg(n),s.Reg(i))],k.Bool];case u.Greater:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Gt,s.Reg(n),s.Reg(i))],k.Bool];case u.GreaterEqual:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Geq,s.Reg(n),s.Reg(i))],k.Bool];case u.EqualEqual:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Eq,s.Reg(n),s.Reg(i))],k.Bool];case u.BangEqual:return[c,[...r,...o,s.BinOp(c,s.BinOperator.Neq,s.Reg(n),s.Reg(i))],k.Bool];case u.VertBarVertBar:{const l=F(),g=F();return[c,[...r,s.GotoT(s.Reg(n),l),...o,s.Set(c,s.Reg(i)),s.Goto(g),s.Label(l),s.Set(c,s.Imm(1)),s.Label(g)],k.Bool]}case u.AmpAmp:{const l=F(),g=F();return[c,[...r,s.GotoF(s.Reg(n),l),...o,s.Set(c,s.Reg(i)),s.Goto(g),s.Label(l),s.Set(c,s.Imm(0)),s.Label(g)],k.Bool]}default:f(t.lineNum,`Typecheck fail: Tried to generate IR of invalid binary operator ${t.op}`)}}case"UnOp":{const[n,r,a]=_(t.operand,e),i=E();switch(t.op){case u.Minus:return[i,[...r,s.UnOp(i,s.UnOperator.Neg,s.Reg(n))],k.Int];case u.Plus:return[i,[...r,s.UnOp(i,s.UnOperator.UPlus,s.Reg(n))],k.Int];case u.Bang:return[i,[...r,s.UnOp(i,s.UnOperator.Not,s.Reg(n))],k.Bool];case u.Alloc:return[i,[...r,s.Alloc(i,s.Reg(n))],k.Ptr(k.Bool)];case u.Print:return[i,[...r,s.Print(i,s.Reg(n))],a];default:f(t.lineNum,`Typecheck fail: Tried to generate IR of invalid unary operator ${t.op}`)}}case"Cast":{const[n,r,a]=_(t.left,e);return[n,[...r],h.toArth(t.type)]}case"Call":{t.returnType===void 0&&f(t.lineNum,"Typecheck fail: return type of call not updated.");let n=[],r=[];for(const i of t.args){const[o,d,c]=_(i,e);r=[...r,...d],n.push(s.Reg(o))}const a=E();return r=[...r,s.Call(a,t.calleeName,n)],[a,r,h.toArth(t.returnType)]}default:w(t)}}function ht(t){switch(t.kind){case"Bool":return 1;case"Int":return 4;case"Ptr":return 4;case"Func":f(0,`Cannot get size of ${h.stringOfType(t)}`);default:w(t)}}function Z(t,e,n){switch(t.kind){case"VarDecl":{const[r,a,i]=_(t.expr,e),o=E(),d=t.ntp.name,c=t.ntp.type,l=ht(c);return e.define(d,[o,c]),l===4?[...a,s.Alloc(o,s.Imm(l)),s.StoreWord(s.Reg(r),o)]:[...a,s.Alloc(o,s.Imm(l)),s.StoreByte(s.Reg(r),o)]}case"Return":{const[r,a,i]=_(t.expr,e);return[...a,s.Ret(s.Reg(r))]}case"ExprStmt":{const[r,a,i]=_(t.expr,e);return a}case"If":{const[r,a,i]=_(t.cond,e),o=new P(e),d=Z(t.true_arm,o,n),c=new P(e),l=Z(t.false_arm,c,n),g=F(),p=F();return[...a,s.GotoF(s.Reg(r),g),...d,s.Goto(p),s.Label(g),...l,s.Label(p)]}case"While":{const[r,a,i]=_(t.cond,e),o=F(),d=F(),c=new De(n);c.defineCondLabel(o),c.defineExitLabel(d);const l=new P(e),g=Z(t.body,l,c);return[s.Label(o),...a,s.GotoF(s.Reg(r),d),...g,s.Goto(o),s.Label(d)]}case"Block":{const r=new P(e);return Tt(t.stmts,r,n)}case"FnDecl":{const r=new P(e);let a=[];for(const c of t.args){const l=E(),g=ht(c.type),p=s.Alloc(l,s.Imm(g));g===4?a=[...a,p,s.StoreWord(s.Reg(c.name),l)]:a=[...a,p,s.StoreByte(s.Reg(c.name),l)],r.define(c.name,[l,c.type])}const i=new De(void 0),o=[...a,...Z(t.body,r,i)],d=t.args.map(c=>c.name);return[s.FnDecl(t.name,d,o)]}case"Break":{const r=n.getExitLabel();return r===void 0&&f(t.lineNum,"Break statement is not part of a while loop."),[s.Goto(r)]}case"Continue":{const r=n.getCondLabel();return r===void 0&&f(t.lineNum,"Continue statement is not part of a while loop."),[s.Goto(r)]}default:w(t)}}function Tt(t,e,n){let r=[];for(const a of t)r=[...r,...Z(a,e,n)];return r}function Ki(t){return[...Tt(t,new P(void 0),new De(void 0)),s.Halt]}function Yi(t,e){for(const n of t)if(n.kind==="FnDecl"){const r=n.name,a=n.args.map(i=>i.type);e.lookupCurrentScope(r)!==void 0&&f(n.lineNum,`Redeclaration of function ${r}`),e.define(r,h.Func(a,n.returnType))}return e}function Ji(t){Lt(t,void 0,new P(void 0))}function Lt(t,e,n){n=Yi(t,n);for(const r of t)Q(r,e,n)}function Q(t,e,n){switch(t.kind){case"Return":{const r=R(t.expr,n);e===void 0&&f(t.lineNum,"Return statement does not belong to any function"),h.isEqual(r,e)||f(t.lineNum,`Expected ${h.stringOfType(e)} as return type but got ${h.stringOfType(r)}`);break}case"VarDecl":{const r=R(t.expr,n),a=t.ntp.name;n.lookupCurrentScope(a)!==void 0&&f(t.lineNum,`Redeclaration of ${a}`);const i=t.ntp.type;h.isEqual(r,i)||f(t.lineNum,`Variable ${a} was declared as ${h.stringOfType(i)} but is assigned ${h.stringOfType(r)}`),n.define(a,r);break}case"Block":{let r=new P(n);Lt(t.stmts,e,r);break}case"FnDecl":{const r=t.args.map(i=>i.type),a=new P(n);a.define(t.name,h.Func(r,t.returnType));for(const i of t.args)a.lookupCurrentScope(i.name)!==void 0&&f(t.lineNum,`Redeclartion of parameter ${i.name} of ${t.name}.`),a.define(i.name,i.type);Q(t.body,t.returnType,a);break}case"If":{R(t.cond,n).kind!=="Bool"&&f(t.lineNum,"Expected value of type Bool for condition of if statement");const a=new P(n);Q(t.true_arm,e,a);const i=new P(n);Q(t.false_arm,e,i);break}case"While":{R(t.cond,n).kind!=="Bool"&&f(t.lineNum,"Expected value of type Bool for condition of while statement");const a=new P(n);Q(t.body,e,a);break}case"ExprStmt":R(t.expr,n);break;case"Break":case"Continue":break;default:w(t)}}function R(t,e){switch(t.kind){case"Cast":{if(t.left.kind==="Var"){const n=e.lookup(t.left.name);n===void 0&&f(t.lineNum,`Tried to cast undeclared variable ${t.left.name}`),n.kind==="Func"&&f(t.lineNum,`Cannot cast value of type ${h.stringOfType(n)}`)}return t.type}case"Const":{if(typeof t.value=="number")return h.Int;if(typeof t.value=="boolean")return h.Bool;f(t.lineNum,`Type of constant ${t.value} is unknown`)}case"Var":{let n=e.lookup(t.name);return n===void 0&&f(t.lineNum,`Use of undeclared variable ${t.name}`),n}case"AddrOf":{let n=e.lookup(t.operand);return n===void 0&&f(t.lineNum,`Use of undeclared variable ${t.operand}`),h.Ptr(n)}case"Deref":{let n=R(t.operand,e);if(n.kind==="Ptr")return n.inner;f(t.lineNum,`Cannot dereference a ${h.stringOfType(n)}`)}case"PtrUpdate":{let n=R(t.left,e),r=R(t.right,e);if(n.kind==="Ptr"){if(h.isEqual(n.inner,r))return r;f(t.lineNum,`Types of ${h.stringOfType(n.inner)} and ${h.stringOfType(r)} do not match`)}f(t.lineNum,`Cannot perform ptr update on non ptr type ${h.stringOfType(n)}`)}case"Assign":{let n=e.lookup(t.name);n===void 0&&f(t.lineNum,`Use of undeclared variable ${t.name}`);let r=R(t.expr,e);if(h.isEqual(n,r))return n;f(t.lineNum,`Types of ${h.stringOfType(n)} and ${h.stringOfType(r)} do not match`)}case"Call":{const n=e.lookup(t.calleeName);n===void 0&&f(t.lineNum,`Use of undeclared variable ${t.calleeName}`),n.kind!=="Func"&&f(t.lineNum,`Tried to call ${t.calleeName} when it is not a function`);const r=t.args.map(o=>R(o,e)),a=n.args;r.length!==a.length&&f(t.lineNum,`Mismatched number of arguments for ${t.calleeName} with its definition`);for(let o=0;o<r.length;o++){const d=r[o],c=a[o];h.isEqual(d,c)||f(t.lineNum,`Mismatched argument types for argument ${o+1} of ${t.calleeName}. Expected a ${h.stringOfType(c)} but got a ${h.stringOfType(d)}`)}const i=n.returnType;return t.returnType=n.returnType,i}case"UnOp":{const n=R(t.operand,e);switch(t.op){case u.Minus:{if(n.kind==="Int")return h.Int;f(t.lineNum,`Expected Int for operator ${t.op}`)}case u.Plus:{if(n.kind==="Int")return h.Int;f(t.lineNum,`Expected Int for operator ${t.op}`)}case u.Bang:{if(n.kind==="Bool")return h.Bool;f(t.lineNum,`Expected Bool for operator ${t.op}`)}case u.Alloc:return n.kind!=="Int"&&f(t.lineNum,`Expected Int for operator ${t.op}`),h.Ptr(h.Bool);case u.Print:return n.kind==="Func"&&f(t.lineNum,`Cannot print operand of type ${h.stringOfType(n)}`),n}f(t.lineNum,`Invalid unary operator ${t.op}`)}case"BinOp":{const n=R(t.left,e),r=R(t.right,e);switch(t.op){case u.Plus:{if(h.isEqual(n,r)){if(n.kind==="Int")return h.Int;f(t.lineNum,`Operator ${t.op} doesn't allow ${h.stringOfType(n)} + ${h.stringOfType(r)}`)}if(n.kind==="Ptr"&&r.kind==="Int")return n;if(n.kind==="Int"&&r.kind==="Ptr")return r;f(t.lineNum,`Operator ${t.op} doesn't allow ${h.stringOfType(n)} + ${h.stringOfType(r)}`)}case u.Minus:{if(h.isEqual(n,r)){if(n.kind==="Int"||n.kind==="Ptr")return h.Int;f(t.lineNum,`Operator ${t.op} doesn't allow ${h.stringOfType(n)} - ${h.stringOfType(r)}`)}if(n.kind==="Ptr"&&r.kind==="Int")return n;f(t.lineNum,`Operator ${t.op} doesn't allow ${h.stringOfType(n)} - ${h.stringOfType(r)}`)}case u.Star:case u.Slash:return h.isEqual(n,r)||f(t.lineNum,`Operator ${t.op} only allows operands of same type`),n.kind!=="Int"&&f(t.lineNum,`Operator ${t.op} only allows operands of type Int`),n;case u.Less:case u.LessEqual:case u.Greater:case u.GreaterEqual:return h.isEqual(n,r)||f(t.lineNum,`Operator ${t.op} only allows operands of same type`),n.kind!=="Int"&&n.kind!=="Ptr"&&f(t.lineNum,`Operator ${t.op} only allows operands of type Int or Ptr`),h.Bool;case u.EqualEqual:case u.BangEqual:return h.isEqual(n,r)||f(t.lineNum,`Operator ${t.op} only allows operands of same type`),n.kind==="Func"&&f(t.lineNum,"Function comparison is forbidden"),h.Bool;case u.VertBarVertBar:case u.AmpAmp:return h.isEqual(n,r)||f(t.lineNum,`Operator ${t.op} only allows operands of same type`),n.kind!=="Bool"&&f(t.lineNum,`Operator ${t.op} only allows operands of type Bool`),h.Bool}f(t.lineNum,`Invalid binary operator ${t.op}`)}default:w(t)}}function Xi(t,e,n){const r=i=>{e.innerText+=i+`
`},a=i=>{n.innerText+=i+`
`};try{const o=new me(t).tokenizeAll(),c=new zi(o).parse();Ji(c),Le.check(c),ge.resetFunctionUid(),ge.traverse(c),Fi(),Mi();let l=Ki(c);a("--- Initial IR ---"),a(s.stringOfInstrs(l)),l=Hi(l),a(`
--- Optimized IR ---`),a(s.stringOfInstrs(l));const g=Re.createRegistry(l);Ie.resolveLabels(l),new Wi(l,g,r).execute()}catch(i){r(`Error: ${i.message}`),a(`Error: ${i.message}`)}}const Zi=document.querySelector("#text"),Qi=document.querySelector("#btn-play"),te=document.querySelector("#terminal-output"),ne=document.querySelector("#ir-output"),es=document.querySelector("#btn-clear");Qi.addEventListener("click",()=>{te&&(te.innerHTML=""),ne&&(ne.innerHTML=""),Xi(Zi.value,te,ne)});es.addEventListener("click",()=>{te&&(te.innerHTML=""),ne&&(ne.innerHTML="")})});export default ts();
